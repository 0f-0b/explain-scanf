import{EditorView as G,ViewPlugin as N,BlockType as y,PluginField as L,Direction as D}from"../../view@0.19.12/es2021/view.js";import{RangeSet as c,RangeValue as H}from"../../rangeset@0.19.1/es2021/rangeset.js";import{MapMode as O,Facet as m,combineConfig as A}from"../../state@0.19.3/es2021/state.js";var a=class extends H{compare(e){return this==e||this.constructor==e.constructor&&this.eq(e)}eq(e){return!1}};a.prototype.elementClass="";a.prototype.toDOM=void 0;a.prototype.mapMode=O.TrackBefore;a.prototype.startSide=a.prototype.endSide=-1;a.prototype.point=!0;var u=m.define(),T={class:"",renderEmptyElements:!1,elementStyle:"",markers:()=>c.empty,lineMarker:()=>null,initialSpacer:null,updateSpacer:null,domEventHandlers:{}},f=m.define();function Y(t){return[w(),f.of(Object.assign(Object.assign({},T),t))]}var q=G.baseTheme({".cm-gutters":{display:"flex",height:"100%",boxSizing:"border-box",left:0,zIndex:200},"&light .cm-gutters":{backgroundColor:"#f5f5f5",color:"#999",borderRight:"1px solid #ddd"},"&dark .cm-gutters":{backgroundColor:"#333338",color:"#ccc"},".cm-gutter":{display:"flex !important",flexDirection:"column",flexShrink:0,boxSizing:"border-box",minHeight:"100%",overflow:"hidden"},".cm-gutterElement":{boxSizing:"border-box"},".cm-lineNumbers .cm-gutterElement":{padding:"0 3px 0 5px",minWidth:"20px",textAlign:"right",whiteSpace:"nowrap"},"&light .cm-activeLineGutter":{backgroundColor:"#e2f2ff"},"&dark .cm-activeLineGutter":{backgroundColor:"#222227"}}),g=m.define({combine:t=>t.some(e=>e)});function w(t){let e=[R,q];return t&&t.fixed===!1&&e.push(g.of(!0)),e}var R=N.fromClass(class{constructor(t){this.view=t,this.dom=document.createElement("div"),this.dom.className="cm-gutters",this.dom.setAttribute("aria-hidden","true"),this.gutters=t.state.facet(f).map(e=>new x(t,e));for(let e of this.gutters)this.dom.appendChild(e.dom);this.fixed=!t.state.facet(g),this.fixed&&(this.dom.style.position="sticky"),t.scrollDOM.insertBefore(this.dom,t.contentDOM),this.syncGutters()}update(t){this.updateGutters(t)&&this.syncGutters(),t.geometryChanged&&(this.dom.style.minHeight=this.view.contentHeight+"px"),this.view.state.facet(g)!=!this.fixed&&(this.fixed=!this.fixed,this.dom.style.position=this.fixed?"sticky":"")}syncGutters(){let t=c.iter(this.view.state.facet(u),this.view.viewport.from),e=[],r=this.gutters.map(s=>new E(s,this.view.viewport));this.view.viewportLines(s=>{let i;if(Array.isArray(s.type)){for(let n of s.type)if(n.type==y.Text){i=n;break}}else i=s.type==y.Text?s:void 0;if(!!i){e.length&&(e=[]),M(t,e,s.from);for(let n of r)n.line(this.view,i,e)}},0);for(let s of r)s.finish()}updateGutters(t){let e=t.startState.facet(f),r=t.state.facet(f),s=t.docChanged||t.heightChanged||t.viewportChanged||!c.eq(t.startState.facet(u),t.state.facet(u),t.view.viewport.from,t.view.viewport.to);if(e==r)for(let i of this.gutters)i.update(t)&&(s=!0);else{s=!0;let i=[];for(let n of r){let o=e.indexOf(n);o<0?i.push(new x(this.view,n)):(this.gutters[o].update(t),i.push(this.gutters[o]))}for(let n of this.gutters)n.dom.remove();for(let n of i)this.dom.appendChild(n.dom);this.gutters=i}return s}destroy(){this.dom.remove()}},{provide:L.scrollMargins.from(t=>t.gutters.length==0||!t.fixed?null:t.view.textDirection==D.LTR?{left:t.dom.offsetWidth}:{right:t.dom.offsetWidth})});function C(t){return Array.isArray(t)?t:[t]}function M(t,e,r){for(;t.value&&t.from<=r;)t.from==r&&e.push(t.value),t.next()}var E=class{constructor(e,r){this.gutter=e,this.localMarkers=[],this.i=0,this.height=0,this.cursor=c.iter(e.markers,r.from)}line(e,r,s){this.localMarkers.length&&(this.localMarkers=[]),M(this.cursor,this.localMarkers,r.from);let i=s.length?this.localMarkers.concat(s):this.localMarkers,n=this.gutter.config.lineMarker(e,r,i);n&&i.unshift(n);let o=this.gutter;if(i.length==0&&!o.config.renderEmptyElements)return;let h=r.top-this.height;if(this.i==o.elements.length){let l=new b(e,r.height,h,i);o.elements.push(l),o.dom.appendChild(l.dom)}else{let l=o.elements[this.i];z(i,l.markers)&&(i=l.markers),l.update(e,r.height,h,i)}this.height=r.bottom,this.i++}finish(){let e=this.gutter;for(;e.elements.length>this.i;)e.dom.removeChild(e.elements.pop().dom)}},x=class{constructor(e,r){this.view=e,this.config=r,this.elements=[],this.spacer=null,this.dom=document.createElement("div"),this.dom.className="cm-gutter"+(this.config.class?" "+this.config.class:"");for(let s in r.domEventHandlers)this.dom.addEventListener(s,i=>{let n=e.visualLineAtHeight(i.clientY,e.contentDOM.getBoundingClientRect().top);r.domEventHandlers[s](e,n,i)&&i.preventDefault()});this.markers=C(r.markers(e)),r.initialSpacer&&(this.spacer=new b(e,0,0,[r.initialSpacer(e)]),this.dom.appendChild(this.spacer.dom),this.spacer.dom.style.cssText+="visibility: hidden; pointer-events: none")}update(e){let r=this.markers;if(this.markers=C(this.config.markers(e.view)),this.spacer&&this.config.updateSpacer){let i=this.config.updateSpacer(this.spacer.markers[0],e);i!=this.spacer.markers[0]&&this.spacer.update(e.view,0,0,[i])}let s=e.view.viewport;return!c.eq(this.markers,r,s.from,s.to)}},b=class{constructor(e,r,s,i){this.height=-1,this.above=0,this.dom=document.createElement("div"),this.update(e,r,s,i)}update(e,r,s,i){if(this.height!=r&&(this.dom.style.height=(this.height=r)+"px"),this.above!=s&&(this.dom.style.marginTop=(this.above=s)?s+"px":""),this.markers!=i){this.markers=i;for(let o;o=this.dom.lastChild;)o.remove();let n="cm-gutterElement";for(let o of i){o.toDOM&&this.dom.appendChild(o.toDOM(e));let h=o.elementClass;h&&(n+=" "+h)}this.dom.className=n}}};function z(t,e){if(t.length!=e.length)return!1;for(let r=0;r<t.length;r++)if(!t[r].compare(e[r]))return!1;return!0}var B=m.define(),d=m.define({combine(t){return A(t,{formatNumber:String,domEventHandlers:{}},{domEventHandlers(e,r){let s=Object.assign({},e);for(let i in r){let n=s[i],o=r[i];s[i]=n?(h,l,v)=>n(h,l,v)||o(h,l,v):o}return s}})}}),p=class extends a{constructor(e){super();this.number=e}eq(e){return this.number==e.number}toDOM(e){return document.createTextNode(this.number)}};function k(t,e){return t.state.facet(d).formatNumber(e,t.state)}var V=f.compute([d],t=>({class:"cm-lineNumbers",renderEmptyElements:!1,markers(e){return e.state.facet(B)},lineMarker(e,r,s){return s.some(i=>i.toDOM)?null:new p(k(e,e.state.doc.lineAt(r.from).number))},initialSpacer(e){return new p(k(e,S(e.state.doc.lines)))},updateSpacer(e,r){let s=k(r.view,S(r.view.state.doc.lines));return s==e.number?e:new p(s)},domEventHandlers:t.facet(d).domEventHandlers}));function _(t={}){return[d.of(t),w(),V]}function S(t){let e=9;for(;e<t;)e=e*10+9;return e}var j=new class extends a{constructor(){super(...arguments);this.elementClass="cm-activeLineGutter"}},P=u.compute(["selection"],t=>{let e=[],r=-1;for(let s of t.selection.ranges)if(s.empty){let i=t.doc.lineAt(s.head).from;i>r&&(r=i,e.push(j.range(i)))}return c.of(e)});function J(){return P}export{a as GutterMarker,Y as gutter,u as gutterLineClass,w as gutters,J as highlightActiveLineGutter,B as lineNumberMarkers,_ as lineNumbers};
