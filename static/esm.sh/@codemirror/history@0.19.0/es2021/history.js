import{Annotation as w,Facet as D,combineConfig as E,StateField as k,Transaction as S,ChangeSet as B,ChangeDesc as F,EditorSelection as v,StateEffect as G}from"../../state@0.19.3/es2021/state.js";import{EditorView as U}from"../../view@0.19.12/es2021/view.js";var y=w.define(),R=w.define(),q=D.define(),J=D.define({combine(t){return E(t,{minDepth:100,newGroupDelay:500},{minDepth:Math.max,newGroupDelay:Math.min})}}),p=k.define({create(){return f.empty},update(t,e){let n=e.state.facet(J),s=e.annotation(y);if(s){let u=c.fromTransaction(e),d=s.side,h=d==0?t.undone:t.done;return u?h=m(h,h.length,n.minDepth,u):h=C(h,e.startState.selection),new f(d==0?s.rest:h,d==0?h:s.rest)}let o=e.annotation(R);if((o=="full"||o=="before")&&(t=t.isolate()),e.annotation(S.addToHistory)===!1)return e.changes.empty?t:t.addMapping(e.changes.desc);let r=c.fromTransaction(e),i=e.annotation(S.time),l=e.annotation(S.userEvent);return r?t=t.addChanges(r,i,l,n.newGroupDelay,n.minDepth):e.selection&&(t=t.addSelection(e.startState.selection,i,l,n.newGroupDelay)),(o=="full"||o=="after")&&(t=t.isolate()),t},toJSON(t){return{done:t.done.map(e=>e.toJSON()),undone:t.undone.map(e=>e.toJSON())}},fromJSON(t){return new f(t.done.map(c.fromJSON),t.undone.map(c.fromJSON))}});function X(t={}){return[p,J.of(t),U.domEventHandlers({beforeinput(e,n){return e.inputType=="historyUndo"?N(n):e.inputType=="historyRedo"?O(n):!1}})]}var Y=p;function g(t,e){return function({state:n,dispatch:s}){let o=n.field(p,!1);if(!o)return!1;let r=o.pop(t,n,e);return r?(s(r),!0):!1}}var N=g(0,!1),O=g(1,!1),x=g(0,!0),z=g(1,!0);function M(t){return function(e){let n=e.field(p,!1);if(!n)return 0;let s=t==0?n.done:n.undone;return s.length-(s.length&&!s[0].changes?1:0)}}var Z=M(0),L=M(1),c=class{constructor(e,n,s,o,r){this.changes=e,this.effects=n,this.mapped=s,this.startSelection=o,this.selectionsAfter=r}setSelAfter(e){return new c(this.changes,this.effects,this.mapped,this.startSelection,e)}toJSON(){var e,n,s;return{changes:(e=this.changes)===null||e===void 0?void 0:e.toJSON(),mapped:(n=this.mapped)===null||n===void 0?void 0:n.toJSON(),startSelection:(s=this.startSelection)===null||s===void 0?void 0:s.toJSON(),selectionsAfter:this.selectionsAfter.map(o=>o.toJSON())}}static fromJSON(e){return new c(e.changes&&B.fromJSON(e.changes),[],e.mapped&&F.fromJSON(e.mapped),e.startSelection&&v.fromJSON(e.startSelection),e.selectionsAfter.map(v.fromJSON))}static fromTransaction(e){let n=a;for(let s of e.startState.facet(q)){let o=s(e);o.length&&(n=n.concat(o))}return!n.length&&e.changes.empty?null:new c(e.changes.invert(e.startState.doc),n,void 0,e.startState.selection,a)}static selection(e){return new c(void 0,a,void 0,void 0,e)}};function m(t,e,n,s){let o=e+1>n+20?e-n-1:0,r=t.slice(o,e);return r.push(s),r}function K(t,e){let n=[],s=!1;return t.iterChangedRanges((o,r)=>n.push(o,r)),e.iterChangedRanges((o,r,i,l)=>{for(let u=0;u<n.length;){let d=n[u++],h=n[u++];l>=d&&i<=h&&(s=!0)}}),s}function P(t,e){return t.ranges.length==e.ranges.length&&t.ranges.filter((n,s)=>n.empty!=e.ranges[s].empty).length===0}function T(t,e){return t.length?e.length?t.concat(e):t:e}var a=[],V=200;function C(t,e){if(t.length){let n=t[t.length-1],s=n.selectionsAfter.slice(Math.max(0,n.selectionsAfter.length-V));return s.length&&s[s.length-1].eq(e)?t:(s.push(e),m(t,t.length-1,1e9,n.setSelAfter(s)))}else return[c.selection([e])]}function $(t){let e=t[t.length-1],n=t.slice();return n[t.length-1]=e.setSelAfter(e.selectionsAfter.slice(0,e.selectionsAfter.length-1)),n}function A(t,e){if(!t.length)return t;let n=t.length,s=a;for(;n;){let o=I(t[n-1],e,s);if(o.changes&&!o.changes.empty||o.effects.length){let r=t.slice(0,n);return r[n-1]=o,r}else e=o.mapped,n--,s=o.selectionsAfter}return s.length?[c.selection(s)]:a}function I(t,e,n){let s=T(t.selectionsAfter.length?t.selectionsAfter.map(l=>l.map(e)):a,n);if(!t.changes)return c.selection(s);let o=t.changes.map(e),r=e.mapDesc(t.changes,!0),i=t.mapped?t.mapped.composeDesc(r):r;return new c(o,G.mapEffects(t.effects,e),i,t.startSelection.map(r),s)}var f=class{constructor(e,n,s=0,o=void 0){this.done=e,this.undone=n,this.prevTime=s,this.prevUserEvent=o}isolate(){return this.prevTime?new f(this.done,this.undone):this}addChanges(e,n,s,o,r){let i=this.done,l=i[i.length-1];return l&&l.changes&&!l.changes.empty&&e.changes&&(!l.selectionsAfter.length&&n-this.prevTime<o&&K(l.changes,e.changes)||s=="input.type.compose")?i=m(i,i.length-1,r,new c(e.changes.compose(l.changes),T(e.effects,l.effects),l.mapped,l.startSelection,a)):i=m(i,i.length,r,e),new f(i,a,n,s)}addSelection(e,n,s,o){let r=this.done.length?this.done[this.done.length-1].selectionsAfter:a;return r.length>0&&n-this.prevTime<o&&s==this.prevUserEvent&&s&&/^select($|\.)/.test(s)&&P(r[r.length-1],e)?this:new f(C(this.done,e),this.undone,n,s)}addMapping(e){return new f(A(this.done,e),A(this.undone,e),this.prevTime,this.prevUserEvent)}pop(e,n,s){let o=e==0?this.done:this.undone;if(o.length==0)return null;let r=o[o.length-1];if(s&&r.selectionsAfter.length)return n.update({selection:r.selectionsAfter[r.selectionsAfter.length-1],annotations:y.of({side:e,rest:$(o)}),userEvent:e==0?"select.undo":"select.redo"});if(r.changes){let i=o.length==1?a:o.slice(0,o.length-1);return r.mapped&&(i=A(i,r.mapped)),n.update({changes:r.changes,selection:r.startSelection,effects:r.effects,annotations:y.of({side:e,rest:i}),filter:!1,userEvent:e==0?"undo":"redo"})}else return null}};f.empty=new f(a,a);var _=[{key:"Mod-z",run:N,preventDefault:!0},{key:"Mod-y",mac:"Mod-Shift-z",run:O,preventDefault:!0},{key:"Mod-u",run:x,preventDefault:!0},{key:"Alt-u",mac:"Mod-Shift-u",run:z,preventDefault:!0}];export{X as history,Y as historyField,_ as historyKeymap,q as invertedEffects,R as isolateHistory,O as redo,L as redoDepth,z as redoSelection,N as undo,Z as undoDepth,x as undoSelection};
