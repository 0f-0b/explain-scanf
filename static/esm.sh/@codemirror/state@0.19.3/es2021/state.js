import{Text as x,findClusterBreak as Q}from"../../text@0.19.5/es2021/text.js";import{Text as Ne}from"../../text@0.19.5/es2021/text.js";var C=/\r\n?|\n/,T=function(r){return r[r.Simple=0]="Simple",r[r.TrackDel=1]="TrackDel",r[r.TrackBefore=2]="TrackBefore",r[r.TrackAfter=3]="TrackAfter",r}(T||(T={})),k=class{constructor(e){this.sections=e}get length(){let e=0;for(let t=0;t<this.sections.length;t+=2)e+=this.sections[t];return e}get newLength(){let e=0;for(let t=0;t<this.sections.length;t+=2){let n=this.sections[t+1];e+=n<0?this.sections[t]:n}return e}get empty(){return this.sections.length==0||this.sections.length==2&&this.sections[1]<0}iterGaps(e){for(let t=0,n=0,i=0;t<this.sections.length;){let s=this.sections[t++],l=this.sections[t++];l<0?(e(n,i,s),i+=s):i+=l,n+=s}}iterChangedRanges(e,t=!1){q(this,e,t)}get invertedDesc(){let e=[];for(let t=0;t<this.sections.length;){let n=this.sections[t++],i=this.sections[t++];i<0?e.push(n,i):e.push(i,n)}return new k(e)}composeDesc(e){return this.empty?e:e.empty?this:X(this,e)}mapDesc(e,t=!1){return e.empty?this:M(this,e,t)}mapPos(e,t=-1,n=T.Simple){let i=0,s=0;for(let l=0;l<this.sections.length;){let a=this.sections[l++],o=this.sections[l++],h=i+a;if(o<0){if(h>e)return s+(e-i);s+=a}else{if(n!=T.Simple&&h>=e&&(n==T.TrackDel&&i<e&&h>e||n==T.TrackBefore&&i<e||n==T.TrackAfter&&h>e))return null;if(h>e||h==e&&t<0&&!a)return e==i||t<0?s:s+o;s+=o}i=h}if(e>i)throw new RangeError(`Position ${e} is out of range for changeset of length ${i}`);return s}touchesRange(e,t=e){for(let n=0,i=0;n<this.sections.length&&i<=t;){let s=this.sections[n++],l=this.sections[n++],a=i+s;if(l>=0&&i<=t&&a>=e)return i<e&&a>t?"cover":!0;i=a}return!1}toString(){let e="";for(let t=0;t<this.sections.length;){let n=this.sections[t++],i=this.sections[t++];e+=(e?" ":"")+n+(i>=0?":"+i:"")}return e}toJSON(){return this.sections}static fromJSON(e){if(!Array.isArray(e)||e.length%2||e.some(t=>typeof t!="number"))throw new RangeError("Invalid JSON representation of ChangeDesc");return new k(e)}},m=class extends k{constructor(e,t){super(e);this.inserted=t}apply(e){if(this.length!=e.length)throw new RangeError("Applying change set to a document with the wrong length");return q(this,(t,n,i,s,l)=>e=e.replace(i,i+(n-t),l),!1),e}mapDesc(e,t=!1){return M(this,e,t,!0)}invert(e){let t=this.sections.slice(),n=[];for(let i=0,s=0;i<t.length;i+=2){let l=t[i],a=t[i+1];if(a>=0){t[i]=a,t[i+1]=l;let o=i>>1;for(;n.length<o;)n.push(x.empty);n.push(l?e.slice(s,s+l):x.empty)}s+=l}return new m(t,n)}compose(e){return this.empty?e:e.empty?this:X(this,e,!0)}map(e,t=!1){return e.empty?this:M(this,e,t,!0)}iterChanges(e,t=!1){q(this,e,t)}get desc(){return new k(this.sections)}filter(e){let t=[],n=[],i=[],s=new R(this);e:for(let l=0,a=0;;){let o=l==e.length?1e9:e[l++];for(;a<o||a==o&&s.len==0;){if(s.done)break e;let f=Math.min(s.len,o-a);y(i,f,-1);let c=s.ins==-1?-1:s.off==0?s.ins:0;y(t,f,c),c>0&&D(n,t,s.text),s.forward(f),a+=f}let h=e[l++];for(;a<h;){if(s.done)break e;let f=Math.min(s.len,h-a);y(t,f,-1),y(i,f,s.ins==-1?-1:s.off==0?s.ins:0),s.forward(f),a+=f}}return{changes:new m(t,n),filtered:new k(i)}}toJSON(){let e=[];for(let t=0;t<this.sections.length;t+=2){let n=this.sections[t],i=this.sections[t+1];i<0?e.push(n):i==0?e.push([n]):e.push([n].concat(this.inserted[t>>1].toJSON()))}return e}static of(e,t,n){let i=[],s=[],l=0,a=null;function o(f=!1){if(!f&&!i.length)return;l<t&&y(i,t-l,-1);let c=new m(i,s);a=a?a.compose(c.map(a)):c,i=[],s=[],l=0}function h(f){if(Array.isArray(f))for(let c of f)h(c);else if(f instanceof m){if(f.length!=t)throw new RangeError(`Mismatched change set length (got ${f.length}, expected ${t})`);o(),a=a?a.compose(f.map(a)):f}else{let{from:c,to:d=c,insert:u}=f;if(c>d||c<0||d>t)throw new RangeError(`Invalid change range ${c} to ${d} (in doc of length ${t})`);let S=u?typeof u=="string"?x.of(u.split(n||C)):u:x.empty,O=S.length;if(c==d&&O==0)return;c<l&&o(),c>l&&y(i,c-l,-1),y(i,d-c,O),D(s,i,S),l=d}}return h(e),o(!a),a}static empty(e){return new m(e?[e,-1]:[],[])}static fromJSON(e){if(!Array.isArray(e))throw new RangeError("Invalid JSON representation of ChangeSet");let t=[],n=[];for(let i=0;i<e.length;i++){let s=e[i];if(typeof s=="number")t.push(s,-1);else{if(!Array.isArray(s)||typeof s[0]!="number"||s.some((l,a)=>a&&typeof l!="string"))throw new RangeError("Invalid JSON representation of ChangeSet");if(s.length==1)t.push(s[0],0);else{for(;n.length<i;)n.push(x.empty);n[i]=x.of(s.slice(1)),t.push(s[0],n[i].length)}}}return new m(t,n)}};function y(r,e,t,n=!1){if(e==0&&t<=0)return;let i=r.length-2;i>=0&&t<=0&&t==r[i+1]?r[i]+=e:e==0&&r[i]==0?r[i+1]+=t:n?(r[i]+=e,r[i+1]+=t):r.push(e,t)}function D(r,e,t){if(t.length==0)return;let n=e.length-2>>1;if(n<r.length)r[r.length-1]=r[r.length-1].append(t);else{for(;r.length<n;)r.push(x.empty);r.push(t)}}function q(r,e,t){let n=r.inserted;for(let i=0,s=0,l=0;l<r.sections.length;){let a=r.sections[l++],o=r.sections[l++];if(o<0)i+=a,s+=a;else{let h=i,f=s,c=x.empty;for(;h+=a,f+=o,o&&n&&(c=c.append(n[l-2>>1])),!(t||l==r.sections.length||r.sections[l+1]<0);)a=r.sections[l++],o=r.sections[l++];e(i,h,s,f,c),i=h,s=f}}}function M(r,e,t,n=!1){let i=[],s=n?[]:null,l=new R(r),a=new R(e);for(let o=0,h=0;;)if(l.ins==-1)o+=l.len,l.next();else if(a.ins==-1&&h<o){let f=Math.min(a.len,o-h);a.forward(f),y(i,f,-1),h+=f}else if(a.ins>=0&&(l.done||h<o||h==o&&(a.len<l.len||a.len==l.len&&!t))){for(y(i,a.ins,-1);o>h&&!l.done&&o+l.len<h+a.len;)o+=l.len,l.next();h+=a.len,a.next()}else if(l.ins>=0){let f=0,c=o+l.len;for(;;)if(a.ins>=0&&h>o&&h+a.len<c)f+=a.ins,h+=a.len,a.next();else if(a.ins==-1&&h<c){let d=Math.min(a.len,c-h);f+=d,a.forward(d),h+=d}else break;y(i,f,l.ins),s&&D(s,i,l.text),o=c,l.next()}else{if(l.done&&a.done)return s?new m(i,s):new k(i);throw new Error("Mismatched change set lengths")}}function X(r,e,t=!1){let n=[],i=t?[]:null,s=new R(r),l=new R(e);for(let a=!1;;){if(s.done&&l.done)return i?new m(n,i):new k(n);if(s.ins==0)y(n,s.len,0,a),s.next();else if(l.len==0&&!l.done)y(n,0,l.ins,a),i&&D(i,n,l.text),l.next();else{if(s.done||l.done)throw new Error("Mismatched change set lengths");{let o=Math.min(s.len2,l.len),h=n.length;if(s.ins==-1){let f=l.ins==-1?-1:l.off?0:l.ins;y(n,o,f,a),i&&f&&D(i,n,l.text)}else l.ins==-1?(y(n,s.off?0:s.len,o,a),i&&D(i,n,s.textBit(o))):(y(n,s.off?0:s.len,l.off?0:l.ins,a),i&&!l.off&&D(i,n,l.text));a=(s.ins>o||l.ins>=0&&l.len>o)&&(a||n.length>h),s.forward2(o),l.forward(o)}}}}var R=class{constructor(e){this.set=e,this.i=0,this.next()}next(){let{sections:e}=this.set;this.i<e.length?(this.len=e[this.i++],this.ins=e[this.i++]):(this.len=0,this.ins=-2),this.off=0}get done(){return this.ins==-2}get len2(){return this.ins<0?this.len:this.ins}get text(){let{inserted:e}=this.set,t=this.i-2>>1;return t>=e.length?x.empty:e[t]}textBit(e){let{inserted:t}=this.set,n=this.i-2>>1;return n>=t.length&&!e?x.empty:t[n].slice(this.off,e==null?void 0:this.off+e)}forward(e){e==this.len?this.next():(this.len-=e,this.off+=e)}forward2(e){this.ins==-1?this.forward(e):e==this.ins?this.next():(this.ins-=e,this.off+=e)}},J=class{constructor(e,t,n){this.from=e,this.to=t,this.flags=n}get anchor(){return this.flags&16?this.to:this.from}get head(){return this.flags&16?this.from:this.to}get empty(){return this.from==this.to}get assoc(){return this.flags&4?-1:this.flags&8?1:0}get bidiLevel(){let e=this.flags&3;return e==3?null:e}get goalColumn(){let e=this.flags>>5;return e==33554431?void 0:e}map(e,t=-1){let n=e.mapPos(this.from,t),i=e.mapPos(this.to,t);return n==this.from&&i==this.to?this:new J(n,i,this.flags)}extend(e,t=e){if(e<=this.anchor&&t>=this.anchor)return g.range(e,t);let n=Math.abs(e-this.anchor)>Math.abs(t-this.anchor)?e:t;return g.range(this.anchor,n)}eq(e){return this.anchor==e.anchor&&this.head==e.head}toJSON(){return{anchor:this.anchor,head:this.head}}static fromJSON(e){if(!e||typeof e.anchor!="number"||typeof e.head!="number")throw new RangeError("Invalid JSON representation for SelectionRange");return g.range(e.anchor,e.head)}},g=class{constructor(e,t=0){this.ranges=e,this.mainIndex=t}map(e,t=-1){return e.empty?this:g.create(this.ranges.map(n=>n.map(e,t)),this.mainIndex)}eq(e){if(this.ranges.length!=e.ranges.length||this.mainIndex!=e.mainIndex)return!1;for(let t=0;t<this.ranges.length;t++)if(!this.ranges[t].eq(e.ranges[t]))return!1;return!0}get main(){return this.ranges[this.mainIndex]}asSingle(){return this.ranges.length==1?this:new g([this.main])}addRange(e,t=!0){return g.create([e].concat(this.ranges),t?0:this.mainIndex+1)}replaceRange(e,t=this.mainIndex){let n=this.ranges.slice();return n[t]=e,g.create(n,this.mainIndex)}toJSON(){return{ranges:this.ranges.map(e=>e.toJSON()),main:this.mainIndex}}static fromJSON(e){if(!e||!Array.isArray(e.ranges)||typeof e.main!="number"||e.main>=e.ranges.length)throw new RangeError("Invalid JSON representation for EditorSelection");return new g(e.ranges.map(t=>J.fromJSON(t)),e.main)}static single(e,t=e){return new g([g.range(e,t)],0)}static create(e,t=0){if(e.length==0)throw new RangeError("A selection needs at least one range");for(let n=0,i=0;i<e.length;i++){let s=e[i];if(s.empty?s.from<=n:s.from<n)return he(e.slice(),t);n=s.to}return new g(e,t)}static cursor(e,t=0,n,i){return new J(e,e,(t==0?0:t<0?4:8)|(n==null?3:Math.min(2,n))|(i??33554431)<<5)}static range(e,t,n){let i=(n??33554431)<<5;return t<e?new J(t,e,16|i):new J(e,t,i)}};function he(r,e=0){let t=r[e];r.sort((n,i)=>n.from-i.from),e=r.indexOf(t);for(let n=1;n<r.length;n++){let i=r[n],s=r[n-1];if(i.empty?i.from<=s.to:i.from<s.to){let l=s.from,a=Math.max(i.to,s.to);n<=e&&e--,r.splice(--n,2,i.anchor>i.head?g.range(a,l):g.range(l,a))}}return new g(r,e)}function Y(r,e){for(let t of r.ranges)if(t.to>e)throw new RangeError("Selection points outside of document")}var U=0,A=class{constructor(e,t,n,i,s){this.combine=e,this.compareInput=t,this.compare=n,this.isStatic=i,this.extensions=s,this.id=U++,this.default=e([])}static define(e={}){return new A(e.combine||(t=>t),e.compareInput||((t,n)=>t===n),e.compare||(e.combine?(t,n)=>t===n:ce),!!e.static,e.enables)}of(e){return new P([],this,0,e)}compute(e,t){if(this.isStatic)throw new Error("Can't compute a static facet");return new P(e,this,1,t)}computeN(e,t){if(this.isStatic)throw new Error("Can't compute a static facet");return new P(e,this,2,t)}from(e,t){return t||(t=n=>n),this.compute([e],n=>t(n.field(e)))}};function ce(r,e){return r==e||r.length==e.length&&r.every((t,n)=>t===e[n])}var P=class{constructor(e,t,n,i){this.dependencies=e,this.facet=t,this.type=n,this.value=i,this.id=U++}dynamicSlot(e){var t;let n=this.value,i=this.facet.compareInput,s=e[this.id]>>1,l=this.type==2,a=!1,o=!1,h=[];for(let f of this.dependencies)f=="doc"?a=!0:f=="selection"?o=!0:(((t=e[f.id])!==null&&t!==void 0?t:1)&1)==0&&h.push(e[f.id]);return(f,c)=>{if(!c||c.reconfigured)return f.values[s]=n(f),1;{if(!(a&&c.docChanged||o&&(c.docChanged||c.selection)||h.some(O=>($(f,O)&1)>0)))return 0;let u=n(f),S=c.startState.values[s];return(l?ue(u,S,i):i(u,S))?0:(f.values[s]=u,1)}}}};function ue(r,e,t){if(r.length!=e.length)return!1;for(let n=0;n<r.length;n++)if(!t(r[n],e[n]))return!1;return!0}function de(r,e,t){let n=t.map(a=>r[a.id]),i=t.map(a=>a.type),s=n.filter(a=>!(a&1)),l=r[e.id]>>1;return(a,o)=>{let h=o?o.reconfigured?o.startState.config.address[e.id]:l<<1:null,f=h==null;for(let u of s)$(a,u)&1&&(f=!0);if(!f)return 0;let c=[];for(let u=0;u<n.length;u++){let S=B(a,n[u]);if(i[u]==2)for(let O of S)c.push(O);else c.push(S)}let d=e.combine(c);return h!=null&&e.compare(d,B(o.startState,h))?0:(a.values[l]=d,1)}}function Z(r,e){let t=r.config.address[e];return t==null?null:t>>1}var j=A.define({static:!0}),E=class{constructor(e,t,n,i,s){this.id=e,this.createF=t,this.updateF=n,this.compareF=i,this.spec=s,this.provides=void 0}static define(e){let t=new E(U++,e.create,e.update,e.compare||((n,i)=>n===i),e);return e.provide&&(t.provides=e.provide(t)),t}create(e){let t=e.facet(j).find(n=>n.field==this);return((t==null?void 0:t.create)||this.createF)(e)}slot(e){let t=e[this.id]>>1;return(n,i)=>{if(!i||i.reconfigured&&Z(i.startState,this.id)==null)return n.values[t]=this.create(n),1;let s,l=0;i.reconfigured?(s=i.startState.values[Z(i.startState,this.id)],l=1):s=i.startState.values[t];let a=this.updateF(s,i);return!l&&!this.compareF(s,a)&&(l=1),l&&(n.values[t]=a),l}}init(e){return[this,j.of({field:this,create:e})]}get extension(){return this}},I={lowest:4,low:3,default:2,high:1,highest:0};function b(r){return e=>new G(e,r)}var Oe={lowest:b(I.lowest),low:b(I.low),default:b(I.default),high:b(I.high),highest:b(I.highest),fallback:b(I.lowest),extend:b(I.high),override:b(I.highest)},G=class{constructor(e,t){this.inner=e,this.prec=t}},z=class{of(e){return new L(this,e)}reconfigure(e){return z.reconfigure.of({compartment:this,extension:e})}get(e){return e.config.compartments.get(this)}},L=class{constructor(e,t){this.compartment=e,this.inner=t}},W=class{constructor(e,t,n,i,s){for(this.base=e,this.compartments=t,this.dynamicSlots=n,this.address=i,this.staticValues=s,this.statusTemplate=[];this.statusTemplate.length<n.length;)this.statusTemplate.push(0)}staticFacet(e){let t=this.address[e.id];return t==null?e.default:this.staticValues[t>>1]}static resolve(e,t,n){let i=[],s=Object.create(null),l=new Map;for(let f of ge(e,t,l))f instanceof E?i.push(f):(s[f.facet.id]||(s[f.facet.id]=[])).push(f);let a=Object.create(null),o=[],h=[];for(let f of i)a[f.id]=h.length<<1,h.push(c=>f.slot(c));for(let f in s){let c=s[f],d=c[0].facet;if(c.every(u=>u.type==0)){a[d.id]=o.length<<1|1;let u=d.combine(c.map(O=>O.value)),S=n?n.config.address[d.id]:null;if(S!=null){let O=B(n,S);d.compare(u,O)&&(u=O)}o.push(u)}else{for(let u of c)u.type==0?(a[u.id]=o.length<<1|1,o.push(u.value)):(a[u.id]=h.length<<1,h.push(S=>u.dynamicSlot(S)));a[d.id]=h.length<<1,h.push(u=>de(u,d,c))}}return new W(e,l,h.map(f=>f(a)),a,o)}};function ge(r,e,t){let n=[[],[],[],[],[]],i=new Map;function s(l,a){let o=i.get(l);if(o!=null){if(o>=a)return;let h=n[o].indexOf(l);h>-1&&n[o].splice(h,1),l instanceof L&&t.delete(l.compartment)}if(i.set(l,a),Array.isArray(l))for(let h of l)s(h,a);else if(l instanceof L){if(t.has(l.compartment))throw new RangeError("Duplicate use of compartment in extensions");let h=e.get(l.compartment)||l.inner;t.set(l.compartment,h),s(h,a)}else if(l instanceof G)s(l.inner,l.prec);else if(l instanceof E)n[a].push(l),l.provides&&s(l.provides,a);else if(l instanceof P)n[a].push(l),l.facet.extensions&&s(l.facet.extensions,a);else{let h=l.extension;if(!h)throw new Error(`Unrecognized extension value in extension set (${l}). This sometimes happens because multiple instances of @codemirror/state are loaded, breaking instanceof checks.`);s(h,a)}}return s(r,I.default),n.reduce((l,a)=>l.concat(a))}function $(r,e){if(e&1)return 2;let t=e>>1,n=r.status[t];if(n==4)throw new Error("Cyclic dependency between fields and/or facets");if(n&2)return n;r.status[t]=4;let i=r.config.dynamicSlots[t](r,r.applying);return r.status[t]=2|i}function B(r,e){return e&1?r.config.staticValues[e>>1]:r.values[e>>1]}var _=A.define(),ee=A.define({combine:r=>r.some(e=>e),static:!0}),te=A.define({combine:r=>r.length?r[0]:void 0,static:!0}),ne=A.define(),ie=A.define(),se=A.define(),re=A.define({combine:r=>r.length?r[0]:!1}),V=class{constructor(e,t){this.type=e,this.value=t}static define(){return new le}},le=class{of(e){return new V(this,e)}},ae=class{constructor(e){this.map=e}of(e){return new w(this,e)}},w=class{constructor(e,t){this.type=e,this.value=t}map(e){let t=this.type.map(this.value,e);return t===void 0?void 0:t==this.value?this:new w(this.type,t)}is(e){return this.type==e}static define(e={}){return new ae(e.map||(t=>t))}static mapEffects(e,t){if(!e.length)return e;let n=[];for(let i of e){let s=i.map(t);s&&n.push(s)}return n}};w.reconfigure=w.define();w.appendConfig=w.define();var v=class{constructor(e,t,n,i,s,l){this.startState=e,this.changes=t,this.selection=n,this.effects=i,this.annotations=s,this.scrollIntoView=l,this._doc=null,this._state=null,n&&Y(n,t.newLength),s.some(a=>a.type==v.time)||(this.annotations=s.concat(v.time.of(Date.now())))}get newDoc(){return this._doc||(this._doc=this.changes.apply(this.startState.doc))}get newSelection(){return this.selection||this.startState.selection.map(this.changes)}get state(){return this._state||this.startState.applyTransaction(this),this._state}annotation(e){for(let t of this.annotations)if(t.type==e)return t.value}get docChanged(){return!this.changes.empty}get reconfigured(){return this.startState.config!=this.state.config}isUserEvent(e){let t=this.annotation(v.userEvent);return!!(t&&(t==e||t.length>e.length&&t.slice(0,e.length)==e&&t[e.length]=="."))}};v.time=V.define();v.userEvent=V.define();v.addToHistory=V.define();v.remote=V.define();function pe(r,e){let t=[];for(let n=0,i=0;;){let s,l;if(n<r.length&&(i==e.length||e[i]>=r[n]))s=r[n++],l=r[n++];else if(i<e.length)s=e[i++],l=e[i++];else return t;!t.length||t[t.length-1]<s?t.push(s,l):t[t.length-1]<l&&(t[t.length-1]=l)}}function oe(r,e,t){var n;let i,s,l;return t?(i=e.changes,s=m.empty(e.changes.length),l=r.changes.compose(e.changes)):(i=e.changes.map(r.changes),s=r.changes.mapDesc(e.changes,!0),l=r.changes.compose(i)),{changes:l,selection:e.selection?e.selection.map(s):(n=r.selection)===null||n===void 0?void 0:n.map(i),effects:w.mapEffects(r.effects,i).concat(w.mapEffects(e.effects,s)),annotations:r.annotations.length?r.annotations.concat(e.annotations):e.annotations,scrollIntoView:r.scrollIntoView||e.scrollIntoView}}function H(r,e,t){let n=e.selection,i=F(e.annotations);return e.userEvent&&(i=i.concat(v.userEvent.of(e.userEvent))),{changes:e.changes instanceof m?e.changes:m.of(e.changes||[],t,r.facet(te)),selection:n&&(n instanceof g?n:g.single(n.anchor,n.head)),effects:F(e.effects),annotations:i,scrollIntoView:!!e.scrollIntoView}}function fe(r,e,t){let n=H(r,e.length?e[0]:{},r.doc.length);e.length&&e[0].filter===!1&&(t=!1);for(let s=1;s<e.length;s++){e[s].filter===!1&&(t=!1);let l=!!e[s].sequential;n=oe(n,H(r,e[s],l?n.changes.newLength:r.doc.length),l)}let i=new v(r,n.changes,n.selection,n.effects,n.annotations,n.scrollIntoView);return we(t?me(i):i)}function me(r){let e=r.startState,t=!0;for(let i of e.facet(ne)){let s=i(r);if(s===!1){t=!1;break}Array.isArray(s)&&(t=t===!0?s:pe(t,s))}if(t!==!0){let i,s;if(t===!1)s=r.changes.invertedDesc,i=m.empty(e.doc.length);else{let l=r.changes.filter(t);i=l.changes,s=l.filtered.invertedDesc}r=new v(e,i,r.selection&&r.selection.map(s),w.mapEffects(r.effects,s),r.annotations,r.scrollIntoView)}let n=e.facet(ie);for(let i=n.length-1;i>=0;i--){let s=n[i](r);s instanceof v?r=s:Array.isArray(s)&&s.length==1&&s[0]instanceof v?r=s[0]:r=fe(e,F(s),!1)}return r}function we(r){let e=r.startState,t=e.facet(se),n=r;for(let i=t.length-1;i>=0;i--){let s=t[i](r);s&&Object.keys(s).length&&(n=oe(r,H(e,s,r.changes.newLength),!0))}return n==r?r:new v(e,r.changes,r.selection,n.effects,n.annotations,n.scrollIntoView)}var ye=[];function F(r){return r==null?ye:Array.isArray(r)?r:[r]}var N=function(r){return r[r.Word=0]="Word",r[r.Space=1]="Space",r[r.Other=2]="Other",r}(N||(N={})),ve=/[\u00df\u0587\u0590-\u05f4\u0600-\u06ff\u3040-\u309f\u30a0-\u30ff\u3400-\u4db5\u4e00-\u9fcc\uac00-\ud7af]/,K;try{K=new RegExp("[\\p{Alphabetic}\\p{Number}_]","u")}catch{}function Se(r){if(K)return K.test(r);for(let e=0;e<r.length;e++){let t=r[e];if(/\w/.test(t)||t>"\x80"&&(t.toUpperCase()!=t.toLowerCase()||ve.test(t)))return!0}return!1}function xe(r){return e=>{if(!/\S/.test(e))return N.Space;if(Se(e))return N.Word;for(let t=0;t<r.length;t++)if(e.indexOf(r[t])>-1)return N.Word;return N.Other}}var p=class{constructor(e,t,n,i=null){if(this.config=e,this.doc=t,this.selection=n,this.applying=null,this.status=e.statusTemplate.slice(),i&&i.startState.config==e)this.values=i.startState.values.slice();else if(this.values=e.dynamicSlots.map(s=>null),i)for(let s in e.address){let l=e.address[s],a=i.startState.config.address[s];a!=null&&(l&1)==0&&(this.values[l>>1]=B(i.startState,a))}this.applying=i,i&&(i._state=this);for(let s=0;s<this.config.dynamicSlots.length;s++)$(this,s<<1);this.applying=null}field(e,t=!0){let n=this.config.address[e.id];if(n==null){if(t)throw new RangeError("Field is not present in this state");return}return $(this,n),B(this,n)}update(...e){return fe(this,e,!0)}applyTransaction(e){let t=this.config,{base:n,compartments:i}=t;for(let s of e.effects)s.is(z.reconfigure)?(t&&(i=new Map,t.compartments.forEach((l,a)=>i.set(a,l)),t=null),i.set(s.value.compartment,s.value.extension)):s.is(w.reconfigure)?(t=null,n=s.value):s.is(w.appendConfig)&&(t=null,n=F(n).concat(s.value));new p(t||W.resolve(n,i,this),e.newDoc,e.newSelection,e)}replaceSelection(e){return typeof e=="string"&&(e=this.toText(e)),this.changeByRange(t=>({changes:{from:t.from,to:t.to,insert:e},range:g.cursor(t.from+e.length)}))}changeByRange(e){let t=this.selection,n=e(t.ranges[0]),i=this.changes(n.changes),s=[n.range],l=F(n.effects);for(let a=1;a<t.ranges.length;a++){let o=e(t.ranges[a]),h=this.changes(o.changes),f=h.map(i);for(let d=0;d<a;d++)s[d]=s[d].map(f);let c=i.mapDesc(h,!0);s.push(o.range.map(c)),i=i.compose(f),l=w.mapEffects(l,f).concat(w.mapEffects(F(o.effects),c))}return{changes:i,selection:g.create(s,t.mainIndex),effects:l}}changes(e=[]){return e instanceof m?e:m.of(e,this.doc.length,this.facet(p.lineSeparator))}toText(e){return x.of(e.split(this.facet(p.lineSeparator)||C))}sliceDoc(e=0,t=this.doc.length){return this.doc.sliceString(e,t,this.lineBreak)}facet(e){let t=this.config.address[e.id];return t==null?e.default:($(this,t),B(this,t))}toJSON(e){let t={doc:this.sliceDoc(),selection:this.selection.toJSON()};if(e)for(let n in e){let i=e[n];i instanceof E&&(t[n]=i.spec.toJSON(this.field(e[n]),this))}return t}static fromJSON(e,t={},n){if(!e||typeof e.doc!="string")throw new RangeError("Invalid JSON representation for EditorState");let i=[];if(n)for(let s in n){let l=n[s],a=e[s];i.push(l.init(o=>l.spec.fromJSON(a,o)))}return p.create({doc:e.doc,selection:g.fromJSON(e.selection),extensions:t.extensions?i.concat([t.extensions]):i})}static create(e={}){let t=W.resolve(e.extensions||[],new Map),n=e.doc instanceof x?e.doc:x.of((e.doc||"").split(t.staticFacet(p.lineSeparator)||C)),i=e.selection?e.selection instanceof g?e.selection:g.single(e.selection.anchor,e.selection.head):g.single(0);return Y(i,n.length),t.staticFacet(ee)||(i=i.asSingle()),new p(t,n,i)}get tabSize(){return this.facet(p.tabSize)}get lineBreak(){return this.facet(p.lineSeparator)||`
`}get readOnly(){return this.facet(re)}phrase(e){for(let t of this.facet(p.phrases))if(Object.prototype.hasOwnProperty.call(t,e))return t[e];return e}languageDataAt(e,t,n=-1){let i=[];for(let s of this.facet(_))for(let l of s(this,t,n))Object.prototype.hasOwnProperty.call(l,e)&&i.push(l[e]);return i}charCategorizer(e){return xe(this.languageDataAt("wordChars",e).join(""))}wordAt(e){let{text:t,from:n,length:i}=this.doc.lineAt(e),s=this.charCategorizer(e),l=e-n,a=e-n;for(;l>0;){let o=Q(t,l,!1);if(s(t.slice(o,l))!=N.Word)break;l=o}for(;a<i;){let o=Q(t,a);if(s(t.slice(a,o))!=N.Word)break;a=o}return l==a?null:g.range(l+n,a+n)}};p.allowMultipleSelections=ee;p.tabSize=A.define({combine:r=>r.length?r[0]:4});p.lineSeparator=te;p.readOnly=re;p.phrases=A.define();p.languageData=_;p.changeFilter=ne;p.transactionFilter=ie;p.transactionExtender=se;z.reconfigure=w.define();function ke(r,e,t={}){let n={};for(let i of r)for(let s of Object.keys(i)){let l=i[s],a=n[s];if(a===void 0)n[s]=l;else if(!(a===l||l===void 0))if(Object.hasOwnProperty.call(t,s))n[s]=t[s](a,l);else throw new Error("Config merge conflict for field "+s)}for(let i in e)n[i]===void 0&&(n[i]=e[i]);return n}export{V as Annotation,le as AnnotationType,k as ChangeDesc,m as ChangeSet,N as CharCategory,z as Compartment,g as EditorSelection,p as EditorState,A as Facet,T as MapMode,Oe as Prec,J as SelectionRange,w as StateEffect,ae as StateEffectType,E as StateField,Ne as Text,v as Transaction,ke as combineConfig};
